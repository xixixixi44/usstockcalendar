<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚¡äº¤æ˜“æ—¥å† & èµ„é‡‘è®°å½•</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .current-date {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .calendar-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .month-calendar {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }

        .month-title {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .day-header {
            text-align: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: #666;
            padding: 5px 2px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .day:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .day.trading-day {
            background: #A5D6A7; /* Light Green */
            color: #333;
        }

        .day.non-trading-day {
            background: #bdc3c7; /* Gray */
            color: white;
        }

        .day.today {
            background: #f39c12 !important;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        .day.has-record {
            font-weight: 900;
        }

        .day.other-month {
            opacity: 0.3;
        }

        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .record-section, .chart-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            grid-column: 1 / -1; /* Span full width */
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .total-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        .total-display .amount {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 15px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
            font-size: 0.9rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: 500;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 1200px) {
            .calendar-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .calendar-grid {
                grid-template-columns: 1fr;
            }
            
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¦ ç¾è‚¡äº¤æ˜“æ—¥å† & èµ„é‡‘è®°å½•</h1>
            <div class="current-date" id="currentDate"></div>
            <div style="margin-top: 15px;">
                <select id="yearSelector" style="padding: 8px 15px; border: none; border-radius: 8px; font-size: 1rem; background: rgba(255,255,255,0.2); color: white; cursor: pointer;">
                </select>
            </div>
        </div>

        <div class="main-content">
            <div class="calendar-section">
                <div class="section-title">
                    ğŸ“… ç¾è‚¡äº¤æ˜“æ—¥å† <span id="calendarYear"></span>
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #A5D6A7;"></div>
                        <span>äº¤æ˜“æ—¥</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #bdc3c7;"></div>
                        <span>ä¼‘å¸‚æ—¥</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12;"></div>
                        <span>ä»Šå¤©</span>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <div class="side-panel">
                <div class="record-section">
                    <div class="section-title">
                        ğŸ’° èµ„é‡‘è®°å½•
                    </div>
                    <div class="total-display">
                        <div>æ€»èµ„é‡‘</div>
                        <div class="amount" id="totalAmount">$0</div>
                    </div>
                    <form id="fundsForm">
                        <div class="form-group">
                            <label for="selectedDate">é€‰æ‹©æ—¥æœŸ</label>
                            <input type="date" id="selectedDate" required>
                        </div>
                        <div class="form-group">
                            <label for="cashAmount">ç°é‡‘é‡‘é¢ ($)</label>
                            <input type="number" id="cashAmount" step="0.01" placeholder="è¾“å…¥ç°é‡‘é‡‘é¢" required>
                        </div>
                        <div class="form-group">
                            <label for="marketAmount">å¸‚åœºæŠ•èµ„ ($)</label>
                            <input type="number" id="marketAmount" step="0.01" placeholder="è¾“å…¥å¸‚åœºæŠ•èµ„é‡‘é¢" required>
                        </div>
                        <div class="button-group">
                            <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜è®°å½•</button>
                            <button type="button" class="btn btn-secondary" id="noChangeBtn">ğŸ“ ä»Šå¤©æ²¡å˜åŒ–</button>
                            <button type="button" class="btn btn-danger" id="deleteBtn">ğŸ—‘ï¸ åˆ é™¤è®°å½•</button>
                        </div>
                    </form>
                    <div id="statusMessage"></div>
                </div>

                <div class="chart-section">
                    <div class="section-title">
                        ğŸ“Š èµ„é‡‘å˜åŒ–è¶‹åŠ¿
                    </div>
                    <div class="chart-container">
                        <canvas id="fundsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®APIç«¯ç‚¹ - è¯·æ›¿æ¢ä¸ºä½ çš„Worker URL
        const API_BASE = 'https://us-stock-calendar-api.teresascottr45677927.workers.dev';
        
        class USStockCalendar {
            constructor() {
                this.currentDate = new Date();
                this.selectedDate = new Date();
                this.currentYear = this.currentDate.getFullYear();
                this.displayYear = this.currentYear;
                this.fundsData = [];
                this.chart = null;
                this.holidays = [];
                this.password = null;
                this.init();
            }

            calculateEaster(year) {
                const a = year % 19;
                const b = Math.floor(year / 100);
                const c = year % 100;
                const d = Math.floor(b / 4);
                const e = b % 4;
                const f = Math.floor((b + 8) / 25);
                const g = Math.floor((b - f + 1) / 3);
                const h = (19 * a + b - d - g + 15) % 30;
                const i = Math.floor(c / 4);
                const k = c % 4;
                const l = (32 + 2 * e + 2 * i - h - k) % 7;
                const m = Math.floor((a + 11 * h + 22 * l) / 451);
                const month = Math.floor((h + l - 7 * m + 114) / 31);
                const day = ((h + l - 7 * m + 114) % 31) + 1;
                return new Date(year, month - 1, day);
            }

            getNthWeekdayOfMonth(year, month, weekday, n) {
                const firstDay = new Date(year, month, 1);
                const firstWeekday = firstDay.getDay();
                const daysToAdd = (weekday - firstWeekday + 7) % 7;
                return new Date(year, month, 1 + daysToAdd + (n - 1) * 7);
            }

            getLastWeekdayOfMonth(year, month, weekday) {
                const lastDay = new Date(year, month + 1, 0);
                const lastWeekday = lastDay.getDay();
                const daysToSubtract = (lastWeekday - weekday + 7) % 7;
                return new Date(year, month + 1, 0 - daysToSubtract);
            }

            adjustHolidayForWeekend(date) {
                const day = date.getDay();
                if (day === 0) { // Sunday -> Monday
                    return new Date(date.getFullYear(), date.getMonth(), date.getDate() + 1);
                } else if (day === 6) { // Saturday -> Friday
                    return new Date(date.getFullYear(), date.getMonth(), date.getDate() - 1);
                }
                return date;
            }

            calculateHolidays(year) {
                const holidays = [];
                const addHoliday = (date, name) => holidays.push({ date, name });

                addHoliday(this.adjustHolidayForWeekend(new Date(year, 0, 1)), "New Year's Day");
                addHoliday(this.getNthWeekdayOfMonth(year, 0, 1, 3), "Martin Luther King, Jr. Day");
                addHoliday(this.getNthWeekdayOfMonth(year, 1, 1, 3), "Washington's Birthday");
                const easter = this.calculateEaster(year);
                addHoliday(new Date(easter.getFullYear(), easter.getMonth(), easter.getDate() - 2), "Good Friday");
                addHoliday(this.getLastWeekdayOfMonth(year, 4, 1), "Memorial Day");
                if (year >= 2021) {
                    addHoliday(this.adjustHolidayForWeekend(new Date(year, 5, 19)), "Juneteenth National Independence Day");
                }
                addHoliday(this.adjustHolidayForWeekend(new Date(year, 6, 4)), "Independence Day");
                addHoliday(this.getNthWeekdayOfMonth(year, 8, 1, 1), "Labor Day");
                addHoliday(this.getNthWeekdayOfMonth(year, 10, 4, 4), "Thanksgiving Day");
                addHoliday(this.adjustHolidayForWeekend(new Date(year, 11, 25)), "Christmas Day");

                return holidays;
            }

            init() {
                this.updateCurrentDate();
                this.setupYearSelector();
                this.updateDisplayYear();
                this.initForm();
                this.initChart();
                this.loadFundsData();
                this.setSelectedDateToToday();
            }

            setupYearSelector() {
                const selector = document.getElementById('yearSelector');
                const currentYear = this.currentDate.getFullYear();
                
                selector.innerHTML = '';
                for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 'å¹´';
                    if (year === this.displayYear) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                }

                selector.addEventListener('change', (e) => {
                    this.displayYear = parseInt(e.target.value);
                    this.updateDisplayYear();
                });
            }

            updateDisplayYear() {
                this.holidays = this.calculateHolidays(this.displayYear);
                document.getElementById('calendarYear').textContent = this.displayYear + 'å¹´';
                this.renderCalendar();
                this.loadFundsData();
            }

            updateCurrentDate() {
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                document.getElementById('currentDate').textContent = this.currentDate.toLocaleDateString('zh-CN', options);
            }

            setSelectedDateToToday() {
                const today = new Date();
                if (this.displayYear === today.getFullYear()) {
                    document.getElementById('selectedDate').value = today.toISOString().split('T')[0];
                } else {
                    const firstDay = new Date(this.displayYear, 0, 1);
                    document.getElementById('selectedDate').value = firstDay.toISOString().split('T')[0];
                }
            }

            getHoliday(date) {
                return this.holidays.find(holiday => this.isSameDate(holiday.date, date));
            }

            isTradingDay(date) {
                if (date.getDay() === 0 || date.getDay() === 6) {
                    return false;
                }
                return !this.getHoliday(date);
            }

            renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                grid.innerHTML = '';

                const months = ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'];
                const dayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

                for (let month = 0; month < 12; month++) {
                    const monthDiv = document.createElement('div');
                    monthDiv.className = 'month-calendar';

                    const title = document.createElement('div');
                    title.className = 'month-title';
                    title.textContent = months[month];
                    monthDiv.appendChild(title);

                    const daysGrid = document.createElement('div');
                    daysGrid.className = 'days-grid';

                    dayHeaders.forEach(day => {
                        const header = document.createElement('div');
                        header.className = 'day-header';
                        header.textContent = day;
                        daysGrid.appendChild(header);
                    });

                    const firstDayOfMonth = new Date(this.displayYear, month, 1);
                    const startDate = new Date(firstDayOfMonth);
                    startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay());

                    for (let i = 0; i < 42; i++) {
                        const currentDate = new Date(startDate);
                        currentDate.setDate(startDate.getDate() + i);
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'day';
                        dayDiv.textContent = currentDate.getDate();

                        if (currentDate.getMonth() !== month) {
                            dayDiv.classList.add('other-month');
                        } else {
                            const holiday = this.getHoliday(currentDate);
                            if (this.isTradingDay(currentDate)) {
                                dayDiv.classList.add('trading-day');
                                dayDiv.addEventListener('click', () => this.selectDate(currentDate));
                            } else {
                                dayDiv.classList.add('non-trading-day');
                                dayDiv.title = holiday ? holiday.name : 'å‘¨æœ«';
                            }

                            if (this.isSameDate(currentDate, this.currentDate) && this.displayYear === this.currentDate.getFullYear()) {
                                dayDiv.classList.add('today');
                            }
                        }
                        daysGrid.appendChild(dayDiv);
                    }
                    monthDiv.appendChild(daysGrid);
                    grid.appendChild(monthDiv);
                }
            }

            isSameDate(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            }

            selectDate(date) {
                this.selectedDate = date;
                document.getElementById('selectedDate').value = date.toISOString().split('T')[0];
                this.loadRecordForDate(date);
            }

            getPassword() {
                if (this.password) {
                    return this.password;
                }
                const pw = prompt("è¯·è¾“å…¥å¯†ç ä»¥ç»§ç»­æ“ä½œï¼š");
                if (pw) {
                    this.password = pw;
                }
                return pw;
            }

            initForm() {
                const form = document.getElementById('fundsForm');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveFundsRecord();
                });

                document.getElementById('noChangeBtn').addEventListener('click', () => {
                    this.saveNoChangeRecord();
                });

                document.getElementById('deleteBtn').addEventListener('click', () => {
                    this.deleteFundsRecord();
                });

                document.getElementById('selectedDate').addEventListener('change', (e) => {
                    const selectedDate = new Date(e.target.value + 'T12:00:00');
                    this.loadRecordForDate(selectedDate);
                });
            }

            async deleteFundsRecord() {
                const dateStr = document.getElementById('selectedDate').value;
                if (!dateStr) {
                    this.showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ—¥æœŸ', 'error');
                    return;
                }

                const password = this.getPassword();
                if (!password) {
                    this.showMessage('æ“ä½œå·²å–æ¶ˆ', 'error');
                    return;
                }

                if (confirm(`æ‚¨ç¡®å®šè¦åˆ é™¤ ${dateStr} çš„è®°å½•å—ï¼Ÿ`)) {
                    try {
                        const response = await fetch(`${API_BASE}/api/funds`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ date: dateStr, password: password })
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            this.showMessage('è®°å½•å·²åˆ é™¤', 'success');
                            this.password = null; // Clear password on success
                            this.loadFundsData();
                            document.getElementById('cashAmount').value = '';
                            document.getElementById('marketAmount').value = '';
                        } else {
                            throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤è®°å½•æ—¶å‡ºé”™:', error);
                        this.showMessage(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                        this.password = null; // Clear password on failure
                    }
                }
            }

            async saveFundsRecord() {
                const password = this.getPassword();
                if (!password) {
                    this.showMessage('æ“ä½œå·²å–æ¶ˆ', 'error');
                    return;
                }

                const dateStr = document.getElementById('selectedDate').value;
                const cash = parseFloat(document.getElementById('cashAmount').value);
                const market = parseFloat(document.getElementById('marketAmount').value);

                if (!dateStr || isNaN(cash) || isNaN(market)) {
                    this.showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€å­—æ®µ', 'error');
                    return;
                }

                const selectedDate = new Date(dateStr + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (selectedDate > today) {
                    this.showMessage('ä¸èƒ½ä¸ºæœªæ¥æ—¥æœŸè®°å½•èµ„é‡‘', 'error');
                    return;
                }

                if (!this.isTradingDay(selectedDate)) {
                    this.showMessage('åªèƒ½åœ¨äº¤æ˜“æ—¥è®°å½•èµ„é‡‘å˜åŒ–', 'error');
                    return;
                }

                const record = {
                    date: dateStr,
                    cash: cash,
                    marketFunds: market,
                    totalFunds: cash + market,
                    timestamp: new Date().toISOString(),
                    isChanged: true,
                    password: password
                };

                try {
                    const response = await fetch(`${API_BASE}/api/funds`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(record)
                    });

                    if (response.ok) {
                        this.showMessage('èµ„é‡‘è®°å½•ä¿å­˜æˆåŠŸï¼', 'success');
                        this.password = null; // Clear password on success
                        this.loadFundsData();
                        this.updateTotalDisplay(record.totalFunds);
                    } else {
                        const errorResult = await response.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                        throw new Error(errorResult.error);
                    }
                } catch (error) {
                    console.error('ä¿å­˜è®°å½•æ—¶å‡ºé”™:', error);
                    this.showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                    this.password = null; // Clear password on failure
                }
            }

            async saveNoChangeRecord() {
                const password = this.getPassword();
                if (!password) {
                    this.showMessage('æ“ä½œå·²å–æ¶ˆ', 'error');
                    return;
                }

                const dateStr = document.getElementById('selectedDate').value;
                if (!dateStr) {
                    this.showMessage('è¯·é€‰æ‹©æ—¥æœŸ', 'error');
                    return;
                }

                const selectedDate = new Date(dateStr + 'T00:00:00');
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (selectedDate > today) {
                    this.showMessage('ä¸èƒ½ä¸ºæœªæ¥æ—¥æœŸè®°å½•èµ„é‡‘', 'error');
                    return;
                }

                if (!this.isTradingDay(selectedDate)) {
                    this.showMessage('ä¼‘å¸‚æ—¥æ— éœ€è®°å½•', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/funds/no-change`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date: dateStr, password: password })
                    });

                    if (response.ok) {
                        this.showMessage('å·²è®°å½•ï¼šä»Šå¤©æ²¡æœ‰å˜åŒ–', 'success');
                        this.password = null; // Clear password on success
                        this.loadFundsData();
                    } else {
                        const errorResult = await response.json().catch(() => ({error: 'ä¿å­˜å¤±è´¥'}));
                        throw new Error(errorResult.error);
                    }
                } catch (error) {
                    console.error('ä¿å­˜æ— å˜åŒ–è®°å½•æ—¶å‡ºé”™:', error);
                    this.showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                    this.password = null; // Clear password on failure
                }
            }

            async loadFundsData() {
                try {
                    const response = await fetch(`${API_BASE}/api/funds`);
                    if (response.ok) {
                        this.fundsData = await response.json();
                        this.updateChart();
                        this.updateCalendarMarkers();
                        if (this.fundsData.length > 0) {
                            const latest = this.fundsData[this.fundsData.length - 1];
                            this.updateTotalDisplay(latest.totalFunds);
                        } else {
                            this.updateTotalDisplay(0);
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½èµ„é‡‘æ•°æ®æ—¶å‡ºé”™:', error);
                    this.showMessage('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                }
            }

            async loadRecordForDate(date) {
                const dateStr = date.toISOString().split('T')[0];
                const record = this.fundsData.find(r => r.date === dateStr);
                
                document.getElementById('cashAmount').value = record?.cash || '';
                document.getElementById('marketAmount').value = record?.marketFunds || '';
                this.updateTotalDisplay(record?.totalFunds || 0);
            }

            updateTotalDisplay(total) {
                const formatter = new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
                document.getElementById('totalAmount').textContent = formatter.format(total || 0);
            }

            updateCalendarMarkers() {
                document.querySelectorAll('.day.has-record').forEach(day => day.classList.remove('has-record'));

                this.fundsData.forEach(record => {
                    const recordDate = new Date(record.date + 'T12:00:00');
                    if (recordDate.getFullYear() !== this.displayYear) return;
                    
                    document.querySelectorAll('.day:not(.other-month)').forEach(day => {
                        const dayNumber = parseInt(day.textContent);
                        const parent = day.closest('.month-calendar');
                        const monthIndex = Array.from(parent.parentNode.children).indexOf(parent);
                        
                        if (monthIndex > -1) {
                            const dayDate = new Date(this.displayYear, monthIndex, dayNumber);
                            if (this.isSameDate(dayDate, recordDate)) {
                                day.classList.add('has-record');
                            }
                        }
                    });
                });
            }

            initChart() {
                const ctx = document.getElementById('fundsChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: 'æ€»èµ„é‡‘',
                                data: [],
                                type: 'line',
                                borderColor: '#f39c12',
                                backgroundColor: 'rgba(243, 156, 18, 0.2)',
                                borderWidth: 3,
                                tension: 0.4,
                                order: 0
                            },
                            {
                                label: 'ç°é‡‘',
                                data: [],
                                backgroundColor: 'rgba(165, 214, 167, 0.7)',
                                stack: 'funds',
                                order: 1
                            },
                            {
                                label: 'å¸‚åœºæŠ•èµ„',
                                data: [],
                                backgroundColor: 'rgba(118, 75, 162, 0.7)',
                                stack: 'funds',
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: { callback: value => '$' + value.toLocaleString() }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: context => `${context.dataset.label}: $${context.parsed.y.toLocaleString()}`
                                }
                            },
                            legend: { display: true, position: 'top' }
                        }
                    }
                });
            }

            updateChart() {
                if (!this.chart) return;

                const yearlyData = this.fundsData.filter(r => new Date(r.date).getFullYear() === this.displayYear);

                if (yearlyData.length === 0) {
                    this.chart.data.labels = [];
                    this.chart.data.datasets.forEach(dataset => dataset.data = []);
                    this.chart.update();
                    return;
                }

                const sortedData = [...yearlyData].sort((a, b) => new Date(a.date) - new Date(b.date));
                const labels = sortedData.map(record => new Date(record.date).toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));

                this.chart.data.labels = labels;
                this.chart.data.datasets[0].data = sortedData.map(r => r.totalFunds);
                this.chart.data.datasets[1].data = sortedData.map(r => r.cash);
                this.chart.data.datasets[2].data = sortedData.map(r => r.marketFunds);
                
                this.chart.update();
            }

            showMessage(message, type) {
                const messageDiv = document.getElementById('statusMessage');
                messageDiv.textContent = message;
                messageDiv.className = `status-message ${type}`;
                
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'status-message';
                }, 3000);
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new USStockCalendar();
        });
    </script>
</body>
</html>
